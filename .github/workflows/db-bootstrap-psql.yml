name: DB Bootstrap via psql

on:
  workflow_call:
    inputs:
      db_endpoint:
        description: "PostgreSQL endpoint (host:port or host only if default port)"
        required: true
        type: string
      db_name:
        description: "Database name"
        required: true
        type: string
      db_user:
        description: "Database user"
        required: true
        type: string
      sql_paths:
        description: "Newline-separated list of SQL files to run"
        required: true
        type: string
      sslmode:
        description: "Postgres sslmode"
        required: false
        type: string
        default: "require"
    secrets:
      DB_PASSWORD:
        description: "Password for DB user"
        required: true

jobs:
  db_bootstrap:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout caller repo
        uses: actions/checkout@v4

      - name: Install psql client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Run bootstrap SQL
        env:
          PGPASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          ENDPOINT="${{ inputs.db_endpoint }}"
          DB_NAME="${{ inputs.db_name }}"
          DB_USER="${{ inputs.db_user }}"
          SSLMODE="${{ inputs.sslmode }}"

          HOST="${ENDPOINT}"
          PORT="5432"

          # If the endpoint includes :port, split it
          if [[ "$ENDPOINT" == *:* ]]; then
            HOST="${ENDPOINT%%:*}"
            PORT="${ENDPOINT##*:}"
          fi

          echo "Connecting to $HOST:$PORT/$DB_NAME as $DB_USER"
          IFS=$'\n'
          for file in ${{ inputs.sql_paths }}; do
            file_trimmed="$(echo "$file" | xargs)"
            if [ -z "$file_trimmed" ]; then
              continue
            fi
            echo "Running SQL file: $file_trimmed"
            psql "host=$HOST port=$PORT dbname=$DB_NAME user=$DB_USER sslmode=$SSLMODE" \
              -v ON_ERROR_STOP=1 \
              -f "$file_trimmed"
          done
